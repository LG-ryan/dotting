# ë””ì§€í„¸ ìœ ì‚° ìƒìž (Archive System)

## ê°œìš”

Heritage íŒ¨í‚¤ì§€ ì‚¬ìš©ìžë¥¼ ìœ„í•œ ì˜¤í”„ë¼ì¸ ìž¬ìƒ ê°€ëŠ¥í•œ ZIP ì•„ì¹´ì´ë¸Œ ì‹œìŠ¤í…œìž…ë‹ˆë‹¤.

## í•µì‹¬ ì² í•™

- **ì˜ì†ì„±**: ì„œë¹„ìŠ¤ ì¢…ë£Œ í›„ì—ë„ ìž‘ë™
- **ìœ ë‹ˆë²„ì„¤**: ì „ ì„¸ëŒ€ê°€ ì‚¬ìš© ê°€ëŠ¥
- **í”„ë¦¬ë¯¸ì—„**: ì„ ë¬¼ë¡œì„œì˜ í’ˆê²©

## ì•„í‚¤í…ì²˜

### 1. Backend API

#### POST /api/orders/[id]/archive/generate
ìœ ì‚° ìƒìž ìƒì„± íŠ¸ë¦¬ê±°

**ìš”ì²­**:
```json
{
  "regenerate": false  // ì„ íƒì , ìž¬ìƒì„± ì—¬ë¶€
}
```

**ì‘ë‹µ**:
```json
{
  "success": true,
  "status": "generating",  // or "already_exists"
  "orderId": "uuid",
  "message": "ìœ ì‚° ìƒìžë¥¼ ì¤€ë¹„í•˜ê³  ìžˆìŠµë‹ˆë‹¤"
}
```

#### GET /api/orders/[id]/archive/status
ìƒì„± ìƒíƒœ ì¡°íšŒ

**ì‘ë‹µ**:
```json
{
  "orderId": "uuid",
  "status": "ready",  // not_started, generating, ready, failed
  "archiveUrl": "path/to/archive.zip",
  "generatedAt": "2026-01-18T10:30:00Z",
  "progress": 85,  // 0-100%
  "estimatedSeconds": 12  // ì˜ˆìƒ ë‚¨ì€ ì‹œê°„ (ì´ˆ)
}
```

#### GET /api/orders/[id]/archive/download
ë‹¤ìš´ë¡œë“œ URL ë°˜í™˜ (Signed URL, 1ì‹œê°„ ìœ íš¨)

**ì‘ë‹µ**:
```json
{
  "downloadUrl": "https://...",
  "expiresIn": 3600
}
```

### 2. Worker Process (v4.3: ìŠ¤íŠ¸ë¦¬ë° ì••ì¶•)

**íŠ¸ë¦¬ê±° ì‹œì **:
- `compilation.status = 'approved_for_pdf'`
- `compilation.pdf_url` ì¡´ìž¬

**ì²˜ë¦¬ ë‹¨ê³„** (ì§„í–‰ë¥  ê°€ì¤‘ì¹˜):
1. ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ ë° ì¶”ê°€ (0-40%) - íŒŒì¼ ê°œìˆ˜ ê¸°ë°˜
2. metadata.json ìƒì„± (45%)
3. Start.html ìƒì„± (50%)
4. Guide.pdf ìƒì„± (55%) - í˜„ìž¬ëŠ” txt
5. ìŠ¤íŠ¸ë¦¬ë° ì••ì¶• ì™„ë£Œ (99%) - **ë´‰ì¸ ì—¬ìš´**
6. Storage ì—…ë¡œë“œ (100%)
7. DB ì—…ë°ì´íŠ¸

**ê¸°ìˆ  ìŠ¤íƒ**:
- `archiver`: ìŠ¤íŠ¸ë¦¬ë° ì••ì¶• (ë©”ëª¨ë¦¬ íš¨ìœ¨)
- ì••ì¶• ë ˆë²¨: **9** (ìµœëŒ€ ì••ì¶•, 20-30% í¬ê¸° ê°ì†Œ)
- ì§„í–‰ë¥ : 10% ë‹¨ìœ„ DB ì—…ë°ì´íŠ¸
- ì˜ˆìƒ ì‹œê°„: (ê²½ê³¼ ì‹œê°„ / ì§„í–‰ë¥ ) Ã— (100 - ì§„í–‰ë¥ )

### 3. ZIP êµ¬ì¡° (v4.3: ìœ ë‹ˆë²„ì„¤ í”„ë¦¬ë¯¸ì—„)

```
{ì´ë¦„}_ì´ì•¼ê¸°_DOTTING.zip
â”œâ”€ Start.html          (ì˜¤í”„ë¼ì¸ í”Œë ˆì´ì–´, ìœ ë‹ˆë²„ì„¤)
â”œâ”€ Guide.pdf           (ì‚¬ìš© ì•ˆë‚´ì„œ, ì¸ì‡„ í’ˆì§ˆ) âš ï¸ í˜„ìž¬ txt
â”œâ”€ audios/
â”‚   â”œâ”€ 001_opening.mp3
â”‚   â”œâ”€ 002_episode.mp3
â”‚   â””â”€ ...
â””â”€ metadata.json       (í”„ë¡œì íŠ¸ ì •ë³´)
```

**v4.3 ë³€ê²½ì‚¬í•­**:
- `ì—¬ê¸°ë¥¼_ëˆŒëŸ¬ì£¼ì„¸ìš”.html` â†’ `Start.html` (ì§ê´€ì„±)
- `Guide.txt` â†’ `Guide.pdf` (í’ˆê²©, ì¸ì‡„ í’ˆì§ˆ)
- ë©”ëª¨ëž€ ì¶”ê°€: "ê°€ì¡±ê³¼ í•¨ê»˜ ëª©ì†Œë¦¬ë¥¼ ë“¤ì—ˆë˜ ë‚ "

## ì˜¤í”„ë¼ì¸ í”Œë ˆì´ì–´ (Start.html)

### íŠ¹ì§•

- **Zero-Dependency**: ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ìŒ
- **Vanilla JS**: ìˆœìˆ˜ JavaScript
- **Inline CSS**: ëª¨ë“  ìŠ¤íƒ€ì¼ í¬í•¨
- **ìœ ë‹ˆë²„ì„¤ ë””ìžì¸**: 17px ë³¸ë¬¸, 40px ë²„íŠ¼

### Heritage ì°¨ë³„í™”

```css
[data-package="heritage"] .title {
  background: linear-gradient(135deg, #F59E0B, #FCD34D, #F59E0B);
  background-size: 200% 200%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: heritage-glow 3s ease-in-out infinite;
}
```

**íš¨ê³¼**:
- ê¸ˆë°• ê·¸ë¼ë””ì–¸íŠ¸ ì œëª©
- 3ì´ˆ ì£¼ê¸° ë¶€ë“œëŸ¬ìš´ í”¼ì–´ì˜¤ë¦„
- Cubic-bezier (0.4, 0, 0.2, 1) - Ink Spread ì² í•™

### ê¸°ëŠ¥

- ìž¬ìƒ/ì¼ì‹œì •ì§€
- ì´ì „/ë‹¤ìŒ ì—í”¼ì†Œë“œ
- ì§„í–‰ ë°” í´ë¦­ íƒìƒ‰
- ì—í”¼ì†Œë“œ ëª©ë¡ í´ë¦­ ìž¬ìƒ
- í˜„ìž¬ ìž¬ìƒ ì¤‘ í‘œì‹œ

## Frontend ì»´í¬ë„ŒíŠ¸

### ArchiveDownloadButton

**Props**:
```typescript
{
  orderId: string
  packageType: string  // 'heritage'ë§Œ í‘œì‹œ
  onSuccess?: () => void
  onError?: (error: string) => void
}
```

**ê°ì„±ì  ë¡œë”© ì‹œí€€ìŠ¤** (4-6ì´ˆ):
1. ìŒì„± íŒŒì¼ ëª¨ìœ¼ëŠ” ì¤‘... (1.5ì´ˆ)
2. í”Œë ˆì´ì–´ í¬ìž¥ ì¤‘... (2ì´ˆ)
3. ìƒìž ë´‰ì¸ ì¤‘... (1.5ì´ˆ)

**Cubic-bezier ì ìš©**:
```typescript
transitionTimingFunction: 'cubic-bezier(0.4, 0, 0.2, 1)'
```

## Database Schema (v4.3: ì§„í–‰ë¥  ì¶”ê°€)

```sql
ALTER TABLE orders
ADD COLUMN archive_url TEXT,
ADD COLUMN archive_status TEXT CHECK (archive_status IN ('not_started', 'generating', 'ready', 'failed')),
ADD COLUMN archive_generated_at TIMESTAMPTZ,
ADD COLUMN archive_started_at TIMESTAMPTZ,
ADD COLUMN archive_progress INTEGER DEFAULT 0 CHECK (archive_progress >= 0 AND archive_progress <= 100),
ADD COLUMN archive_estimated_seconds INTEGER;
```

## Storage Bucket

**ì´ë¦„**: `archives`
**ì„¤ì •**:
- Public: false (Signed URLë§Œ)
- File size limit: 50MB (Free Plan)
- MIME types: application/zip
- ì••ì¶• ë ˆë²¨: 9 (ìµœëŒ€ ì••ì¶•)

## ë³´ì•ˆ

1. **ì¸ì¦**: Supabase Auth ê¸°ë°˜
2. **ì†Œìœ ê¶Œ ê²€ì¦**: ì£¼ë¬¸ user_id í™•ì¸
3. **íŒ¨í‚¤ì§€ ì œí•œ**: Heritageë§Œ í—ˆìš©
4. **Signed URL**: 1ì‹œê°„ ìœ íš¨

## ì„±ëŠ¥ ìµœì í™”

1. **ì‚¬ì „ ìƒì„±**: íŽ¸ì§‘ ìŠ¹ì¸ ì‹œì ì— ë°±ê·¸ë¼ìš´ë“œ ìƒì„±
2. **ì••ì¶• ë ˆë²¨**: 6 (ê· í˜•)
3. **ìºì‹±**: ìž¬ìƒì„± ìš”ì²­ ì „ê¹Œì§€ ê¸°ì¡´ íŒŒì¼ ì‚¬ìš©

## ì—ëŸ¬ ì²˜ë¦¬ (v4.3: 3ë‹¨ê³„ ìž¬ì‹œë„)

### 1ì°¨ ì‹¤íŒ¨: ìžë™ ìž¬ì‹œë„
- ì‚¬ìš©ìž ë©”ì‹œì§€: "ìž ì‹œ ë¬¸ì œê°€ ìžˆì—ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í• ê²Œìš”"
- 2ì´ˆ ëŒ€ê¸° í›„ ìžë™ ìž¬ì‹œë„
- ì‚¬ìš©ìž ì¸ì§€ ìµœì†Œí™”

### 2ì°¨ ì‹¤íŒ¨: ìˆ˜ë™ ìž¬ì‹œë„
- ëª¨ë‹¬: "ìƒìžê°€ ì¡°ê¸ˆ ë¬´ê±°ì›Œ ì‹œê°„ì´ ê±¸ë¦¬ë„¤ìš”"
- ë²„íŠ¼: [ë‚˜ì¤‘ì— ë°›ê¸°] [ë‹¤ì‹œ ì‹œë„í•˜ê¸°]
- ì‚¬ìš©ìž ì„ íƒê¶Œ ì œê³µ

### 3ì°¨ ì‹¤íŒ¨: ì´ë©”ì¼ ëŒ€ì•ˆ (ìš°ì•„í•œ í›„í‡´)
- ëª¨ë‹¬: "ìƒìžê°€ ì•„ì£¼ ë¬´ê²ê³  ì†Œì¤‘í•˜ì—¬, ì €í¬ê°€ ì •ì„±ê» í¬ìž¥í•´ ë©”ì¼ë¡œ ë°°ë‹¬í•´ ë“œë¦´ê¹Œìš”?"
- ë²„íŠ¼: [ë‹«ê¸°] [ðŸ“§ ë©”ì¼ë¡œ ë°›ê¸°]
- **í†¤**: ì‹¤íŒ¨ â†’ í”„ë¦¬ë¯¸ì—„ ì»¨ì‹œì–´ì§€ ì„œë¹„ìŠ¤
- ë°±ê·¸ë¼ìš´ë“œ ìƒì„± ê³„ì† â†’ ì™„ë£Œ ì‹œ ì´ë©”ì¼ ë°œì†¡

## í…ŒìŠ¤íŠ¸

### ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

1. Heritage íŒ¨í‚¤ì§€ ì£¼ë¬¸ ìƒì„±
2. íŽ¸ì§‘ ìŠ¹ì¸ ì™„ë£Œ
3. ëŒ€ì‹œë³´ë“œì—ì„œ "ìœ ì‚° ìƒìž ê°„ì§í•˜ê¸°" ë²„íŠ¼ í™•ì¸
4. í´ë¦­ â†’ ë¡œë”© ëª¨ë‹¬ í™•ì¸ (4-6ì´ˆ)
5. ZIP ë‹¤ìš´ë¡œë“œ í™•ì¸
6. ì••ì¶• í•´ì œ â†’ Start.html ì‹¤í–‰
7. ì˜¤ë””ì˜¤ ìž¬ìƒ í™•ì¸
8. Heritage ê¸ˆë°• íš¨ê³¼ í™•ì¸

## v4.3 ì—…ë°ì´íŠ¸ (2026-01-18)

### í•µì‹¬ ê°œì„ ì‚¬í•­

1. **ìŠ¤íŠ¸ë¦¬ë° ì••ì¶• (archiver)**
   - JSZip â†’ archiver ì „í™˜
   - ë©”ëª¨ë¦¬ íš¨ìœ¨ í–¥ìƒ
   - ëŒ€ìš©ëŸ‰ íŒŒì¼ ì•ˆì •ì„± í™•ë³´

2. **ì ì‘í˜• í´ë§ (Adaptive Polling)**
   - ì´ˆë°˜: 0.5ì´ˆ (ë¹ ë¥¸ í”¼ë“œë°±)
   - ì¤‘ë°˜: 1ì´ˆ (í‘œì¤€)
   - í›„ë°˜: 2ì´ˆ (ì„œë²„ ë¶€í•˜ ê°ì†Œ)

3. **ì§„í–‰ë¥  ë° ì˜ˆìƒ ì‹œê°„**
   - ì‹¤ì‹œê°„ ì§„í–‰ë¥  í‘œì‹œ (0-100%)
   - ì˜ˆìƒ ì‹œê°„ ë³´ê°„ ì²˜ë¦¬ (ë¶€ë“œëŸ¬ìš´ ì „í™˜)
   - 99% ë´‰ì¸ ì—°ì¶œ (1.5ì´ˆ ëŒ€ê¸°)

4. **3ë‹¨ê³„ ìž¬ì‹œë„ + ì´ë©”ì¼ ëŒ€ì•ˆ**
   - ìžë™ â†’ ìˆ˜ë™ â†’ ì´ë©”ì¼
   - ì‹¤íŒ¨ë¥¼ í”„ë¦¬ë¯¸ì—„ ì„œë¹„ìŠ¤ë¡œ ì „í™˜

5. **Guide ê°œì„ **
   - ì „ë‹¬ ì² í•™ ì¶”ê°€
   - ë©”ëª¨ëž€: "ê°€ì¡±ê³¼ í•¨ê»˜ ëª©ì†Œë¦¬ë¥¼ ë“¤ì—ˆë˜ ë‚ "
   - txt â†’ PDF ì „í™˜ ì˜ˆì •

### í–¥í›„ ê°œì„ 

1. **Guide.pdf í…œí”Œë¦¿**: ì •ì  PDF ìƒì„± (300dpi, Noto Serif KR)
2. **Base64 í°íŠ¸**: Noto Serif KR Subset ìž„ë² ë”©
3. **ì´ë©”ì¼ ì•„ì¹´ì´ë¹™**: ë‹¤ìš´ë¡œë“œ ë§í¬ ë°œì†¡ (7ì¼ ìœ íš¨)
4. **ìž¬ìƒ ì†ë„**: 0.8x, 1.0x, 1.2x ì˜µì…˜
5. **10ì´ˆ ê±´ë„ˆë›°ê¸°**: ì•žìœ¼ë¡œ/ë’¤ë¡œ
6. **íŒŒí˜• ì‹œê°í™”**: SVG Static Waveform

## ì°¸ê³  ë¬¸ì„œ

- PRD v4.0: íŒ¨í‚¤ì§€ 4ë‹¨ê³„ êµ¬ì¡°
- UX/UI Guidelines v1.5: ìœ ë‹ˆë²„ì„¤ ë””ìžì¸
- Brand Story v2.0: 'ê°„ì§í•  ìˆœê°„' ì–¸ì–´
